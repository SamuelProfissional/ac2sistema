<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Projetos</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="topo">
        <h1>Gestão de Projetos</h1>
        
    </div>

    <main class="conteudo">
        <section class="bloco">
            <h2>Projetos cadastrados</h2>
            <ul id="lista-projetos" class="lista-projetos">
                <li>Carregando...</li>
            </ul>
        </section>

        <section class="bloco">
            <h2>Novo projeto</h2>
            <form id="form-projeto">
                <label for="descricao">Descrição</label>
                <input type="text" id="descricao" name="descricao" placeholder="Ex: Atualizar site" required />

                <label for="dataInicio">Data de início</label>
                <input type="date" id="dataInicio" name="dataInicio" required />

                <label for="dataFim">Data de término (opcional)</label>
                <input type="date" id="dataFim" name="dataFim" />

                <button type="submit">Salvar projeto</button>
            </form>
            <div id="mensagem" class="mensagem"></div>
        </section>
    </main>

    <footer class="rodape">
        <small> <strong>AC2 - nome e ra:</strong> <br />
             Caio Souza - 171686<br />
             Samuel Rodrigues -  </small>
    </footer>

    <script>
        const API_URL = 'http://localhost:8081/projetos';
        const lista = document.getElementById('lista-projetos');
        const formulario = document.getElementById('form-projeto');
        const mensagem = document.getElementById('mensagem');

        async function carregarProjetos() {
            lista.innerHTML = '<li>Carregando...</li>';
            try {
                const resposta = await fetch(API_URL);
                if (!resposta.ok) {
                    throw new Error('Erro ao buscar projetos.');
                }
                const dados = await resposta.json();

                if (!Array.isArray(dados) || dados.length === 0) {
                    lista.innerHTML = '<li>Nenhum projeto cadastrado.</li>';
                    return;
                }

                lista.innerHTML = '';
                dados.forEach((item) => {
                    const li = document.createElement('li');
                    const fim = item.dataFim || 'Sem data de término';
                    li.textContent = `${item.descricao} - início: ${item.dataInicio} | fim: ${fim}`;
                    lista.appendChild(li);
                });
            } catch (erro) {
                lista.innerHTML = '<li>Não foi possível carregar os projetos.</li>';
                console.error(erro);
            }
        }

        formulario.addEventListener('submit', async (evento) => {
            evento.preventDefault();
            mensagem.textContent = '';
            mensagem.className = 'mensagem';

            const descricao = formulario.descricao.value.trim();
            const dataInicio = formulario.dataInicio.value;
            const dataFim = formulario.dataFim.value || null;

            if (!descricao || !dataInicio) {
                mensagem.textContent = 'Informe descrição e data de início.';
                mensagem.classList.add('erro');
                return;
            }

            const novoProjeto = { descricao, dataInicio, dataFim };

            try {
                const resposta = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(novoProjeto)
                });

                if (!resposta.ok) {
                    const corpo = await resposta.json().catch(() => ({}));
                    const detalhe = Array.isArray(corpo?.errors) ? corpo.errors.join(', ') : corpo?.message;
                    throw new Error(detalhe || 'Erro ao salvar projeto.');
                }

                mensagem.textContent = 'Projeto salvo!';
                mensagem.classList.add('sucesso');
                formulario.reset();
                carregarProjetos();
            } catch (erro) {
                mensagem.textContent = erro.message;
                mensagem.classList.add('erro');
            }
        });

        carregarProjetos();
    </script>
</body>
</html>
